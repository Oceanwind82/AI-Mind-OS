name: Deploy to Vercel (Prod)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect app directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="."
          if [ -f "aimindos/package.json" ]; then APP_DIR="aimindos"; fi
          if [ ! -f "$APP_DIR/package.json" ]; then
            echo "❌ No package.json in repo root or aimindos/"; exit 1
          fi
          echo "APP_DIR=$APP_DIR" >> $GITHUB_OUTPUT
          echo "Using APP_DIR=$APP_DIR"

      - name: Sanity print (paths & scripts)
        shell: bash
        run: |
          set -euo pipefail
          echo "PWD=$(pwd)"
          ls -la
          echo "----"
          ls -la "${{ steps.detect.outputs.APP_DIR }}"
          echo "---- package.json scripts ----"
          cat "${{ steps.detect.outputs.APP_DIR }}/package.json" | sed -n '/"scripts"/,/"keywords"/p' || true

      - name: Verify required secrets
        shell: bash
        run: |
          set -euo pipefail
          for k in VERCEL_TOKEN VERCEL_ORG_ID VERCEL_PROJECT_ID; do
            v="${!k:-}"
            if [ -z "$v" ]; then
              echo "❌ Missing required secret: $k"; exit 1
            fi
          done
          echo "✅ All Vercel secrets are present."

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ steps.detect.outputs.APP_DIR }}/package-lock.json

      - name: Install deps
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: npm ci --no-audit --no-fund

      - name: Show versions
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          node -v
          npm -v
          npx --yes next --version || true
          npx --yes vercel@latest --version || true

      - name: Build (capture logs)
        id: build
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          set -o pipefail
          CI=1 npm run build 2>&1 | tee build.log

      - name: Deploy with Vercel CLI (prebuilt)
        if: success()
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
          npx vercel build --prod --token="$VERCEL_TOKEN"
          npx vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN"

      - name: Upload build log on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ${{ steps.detect.outputs.APP_DIR }}/build.log
