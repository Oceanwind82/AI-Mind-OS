name: AI Mind OS Deploy

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  deployments: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect app directory
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          APP_DIR="."
          if [ -f "aimindos/package.json" ]; then APP_DIR="aimindos"; fi
          if [ ! -f "$APP_DIR/package.json" ]; then
            echo "âŒ No package.json in repo root or aimindos/"; exit 1
          fi
          echo "APP_DIR=$APP_DIR" >> $GITHUB_OUTPUT
          echo "âœ… Using APP_DIR=$APP_DIR"

      - name: Print debug info
        shell: bash
        run: |
          set -euo pipefail
          echo "ðŸ” PWD=$(pwd)"
          echo "ðŸ” Directory contents:"
          ls -la
          echo "ðŸ” App directory contents:"
          ls -la "${{ steps.detect.outputs.APP_DIR }}"
          echo "ðŸ” Package.json scripts:"
          cat "${{ steps.detect.outputs.APP_DIR }}/package.json" | jq '.scripts' || true

      - name: Verify secrets
        shell: bash
        run: |
          set -euo pipefail
          missing=0
          for k in VERCEL_TOKEN VERCEL_ORG_ID VERCEL_PROJECT_ID; do
            v="${!k:-}"
            if [ -z "$v" ]; then
              echo "âŒ Missing secret: $k"
              missing=1
            else
              echo "âœ… Secret $k is present"
            fi
          done
          if [ $missing -eq 1 ]; then exit 1; fi

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: ${{ steps.detect.outputs.APP_DIR }}/package-lock.json

      - name: Install dependencies
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          npm ci --no-audit --no-fund

      - name: Show environment
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          echo "ðŸ”§ Node: $(node -v)"
          echo "ðŸ”§ npm: $(npm -v)"
          echo "ðŸ”§ Next.js: $(npx --yes next --version || echo 'not found')"

      - name: Build application
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          echo "ðŸ”¨ Building application..."
          CI=1 npm run build 2>&1 | tee build.log

      - name: Deploy to Vercel
        if: success()
        working-directory: ${{ steps.detect.outputs.APP_DIR }}
        run: |
          echo "ðŸš€ Deploying to Vercel..."
          npx vercel pull --yes --environment=production --token="$VERCEL_TOKEN"
          npx vercel build --prod --token="$VERCEL_TOKEN"
          npx vercel deploy --prebuilt --prod --token="$VERCEL_TOKEN"

      - name: Upload logs on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: ${{ steps.detect.outputs.APP_DIR }}/build.log
